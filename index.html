<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>æ¶ˆè€—å“ è³¼å…¥ç”³è«‹ãƒ•ã‚©ãƒ¼ãƒ </title>
<link rel="preconnect" href="https://fonts.googleapis.com">
<link href="https://fonts.googleapis.com/css2?family=Noto+Sans+JP:wght@400;500;700&family=BIZ+UDGothic:wght@400;700&display=swap" rel="stylesheet">
<style>
  :root {
    --primary:     #1565c0;
    --primary-dk:  #0d47a1;
    --primary-lt:  #1976d2;
    --accent:      #e53935;
    --accent-soft: #fff5f5;
    --sky:         #e3f0fb;
    --sky2:        #b3cde8;
    --bg:          #f0f6fc;
    --white:       #ffffff;
    --border:      #b3cde8;
    --ink:         #0d2540;
    --ink-light:   #3a5a7c;
    --success:     #2e7d32;
    --row-even:    #f5faff;
    --row-odd:     #eef5fc;
    --shadow:      0 2px 12px rgba(21,101,192,0.10);
  }

  * { box-sizing: border-box; margin: 0; padding: 0; }

  body {
    font-family: 'Noto Sans JP', 'BIZ UDGothic', sans-serif;
    background: var(--bg);
    color: var(--ink);
    min-height: 100vh;
    padding: 0 0 60px;
  }

  /* ===== HEADER ===== */
  .site-header {
    background: linear-gradient(135deg, var(--primary-dk) 0%, var(--primary-lt) 100%);
    color: var(--white);
    padding: 0 32px;
    display: flex;
    align-items: stretch;
    border-bottom: 4px solid var(--sky2);
    box-shadow: 0 3px 16px rgba(13,71,161,0.18);
  }
  .header-accent {
    background: rgba(255,255,255,0.35);
    width: 7px;
    margin-right: 22px;
    border-radius: 0 3px 3px 0;
  }
  .header-content { padding: 22px 0; }
  .header-title { font-size: 22px; font-weight: 700; letter-spacing: 0.06em; }

  /* ===== PASSWORD SCREEN ===== */
  #pwScreen {
    display: flex;
    align-items: center;
    justify-content: center;
    min-height: calc(100vh - 80px);
    padding: 40px 20px;
  }
  .pw-card {
    background: var(--white);
    border: 1px solid var(--border);
    border-radius: 10px;
    box-shadow: 0 6px 32px rgba(21,101,192,0.14);
    padding: 48px 52px;
    max-width: 420px;
    width: 100%;
    text-align: center;
  }
  .pw-icon {
    width: 64px; height: 64px;
    background: linear-gradient(135deg, var(--primary-dk), var(--primary-lt));
    border-radius: 50%;
    display: flex; align-items: center; justify-content: center;
    margin: 0 auto 20px;
    font-size: 28px;
    color: white;
  }
  .pw-card h2 {
    font-size: 18px;
    font-weight: 700;
    color: var(--ink);
    margin-bottom: 6px;
  }
  .pw-card p {
    font-size: 13px;
    color: var(--ink-light);
    margin-bottom: 28px;
  }
  .pw-input-wrap {
    position: relative;
    margin-bottom: 10px;
  }
  .pw-input-wrap input {
    width: 100%;
    border: 1.5px solid var(--border);
    border-radius: 6px;
    padding: 12px 46px 12px 14px;
    font-family: inherit;
    font-size: 18px;
    letter-spacing: 0.2em;
    color: var(--ink);
    background: var(--bg);
    transition: border-color 0.15s, box-shadow 0.15s;
    text-align: center;
  }
  .pw-input-wrap input:focus {
    outline: none;
    border-color: var(--primary);
    background: var(--white);
    box-shadow: 0 0 0 3px rgba(21,101,192,0.13);
  }
  .pw-input-wrap input.error { border-color: var(--accent); background: var(--accent-soft); }
  .pw-toggle {
    position: absolute;
    right: 12px; top: 50%;
    transform: translateY(-50%);
    background: none; border: none;
    cursor: pointer;
    color: var(--ink-light);
    font-size: 18px;
    padding: 4px;
    line-height: 1;
  }
  .pw-error {
    font-size: 12px;
    color: var(--accent);
    min-height: 18px;
    margin-bottom: 16px;
    text-align: center;
  }
  .btn-pw {
    width: 100%;
    padding: 13px;
    background: linear-gradient(135deg, var(--primary) 0%, var(--primary-lt) 100%);
    color: var(--white);
    border: none;
    border-radius: 6px;
    font-family: inherit;
    font-size: 15px;
    font-weight: 700;
    letter-spacing: 0.08em;
    cursor: pointer;
    transition: opacity 0.15s, transform 0.1s;
    box-shadow: 0 3px 12px rgba(21,101,192,0.28);
  }
  .btn-pw:hover { opacity: 0.9; transform: translateY(-1px); }
  .btn-pw:active { transform: translateY(0); }
  .pw-hint {
    font-size: 11px;
    color: var(--ink-light);
    opacity: 0.55;
    margin-top: 18px;
  }

  /* ===== MAIN FORM ===== */
  #mainForm { display: none; }

  .container {
    max-width: 1060px;
    margin: 32px auto;
    padding: 0 20px;
  }

  /* ===== SECTION BLOCK ===== */
  .section {
    background: var(--white);
    border: 1px solid var(--border);
    border-radius: 6px;
    box-shadow: var(--shadow);
    margin-bottom: 22px;
    overflow: hidden;
  }
  .section-head {
    background: linear-gradient(90deg, var(--primary) 0%, var(--primary-lt) 100%);
    color: var(--white);
    padding: 10px 20px;
    font-size: 13px;
    font-weight: 700;
    letter-spacing: 0.08em;
    display: flex;
    align-items: center;
    gap: 10px;
  }
  .section-head .num {
    background: rgba(255,255,255,0.25);
    border: 1.5px solid rgba(255,255,255,0.6);
    color: var(--white);
    width: 22px; height: 22px;
    border-radius: 50%;
    display: flex; align-items: center; justify-content: center;
    font-size: 12px; font-weight: 700;
  }
  .section-body { padding: 20px 24px; }

  /* ===== FORM GRID ===== */
  .form-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 16px 24px; }
  .form-grid.full { grid-template-columns: 1fr; }

  .field { display: flex; flex-direction: column; gap: 5px; }
  .field label {
    font-size: 11px; font-weight: 700;
    letter-spacing: 0.08em; color: var(--ink-light);
    text-transform: uppercase;
  }
  .field label .required { color: var(--accent); margin-left: 4px; }
  .field input, .field textarea, .field select {
    border: 1.5px solid var(--border);
    border-radius: 4px;
    padding: 9px 12px;
    font-family: inherit; font-size: 14px;
    color: var(--ink); background: var(--bg);
    transition: border-color 0.15s, background 0.15s, box-shadow 0.15s;
    width: 100%;
  }
  .field input:focus, .field textarea:focus, .field select:focus {
    outline: none; border-color: var(--primary);
    background: var(--white);
    box-shadow: 0 0 0 3px rgba(21,101,192,0.12);
  }
  .field input.error, .field textarea.error, .field select.error {
    border-color: var(--accent); background: var(--accent-soft);
  }
  .field .err-msg { font-size: 11px; color: var(--accent); display: none; }
  .field input.error ~ .err-msg,
  .field textarea.error ~ .err-msg,
  .field select.error ~ .err-msg { display: block; }
  .field textarea { resize: vertical; min-height: 70px; }

  /* ===== BUDGET RADIO ===== */
  .budget-wrap { margin-bottom: 20px; }
  .budget-label-top {
    font-size: 11px; font-weight: 700;
    letter-spacing: 0.08em; color: var(--ink-light);
    text-transform: uppercase; margin-bottom: 8px; display: block;
  }
  .budget-label-top .required { color: var(--accent); margin-left: 4px; }
  .budget-group { display: flex; gap: 12px; flex-wrap: wrap; }
  .budget-group label {
    display: flex; align-items: center; gap: 8px;
    font-size: 14px; font-weight: 500; color: var(--ink);
    cursor: pointer; padding: 10px 18px;
    border: 1.5px solid var(--border); border-radius: 5px;
    background: var(--bg);
    transition: border-color 0.12s, background 0.12s, color 0.12s;
    user-select: none;
  }
  .budget-group label:hover { border-color: var(--primary); background: var(--sky); }
  .budget-group input[type="radio"] { accent-color: var(--primary); width: 16px; height: 16px; cursor: pointer; }
  .budget-group label.selected { border-color: var(--primary); background: var(--sky); color: var(--primary-dk); font-weight: 700; }
  .budget-error { font-size: 11px; color: var(--accent); margin-top: 5px; display: none; }
  .budget-error.show { display: block; }

  /* ===== ITEMS TABLE ===== */
  .items-table {
    width: 100%;
    border-collapse: collapse;
    font-size: 13px;
    margin-bottom: 14px;
  }
  .items-table thead tr {
    background: linear-gradient(90deg, var(--primary) 0%, var(--primary-lt) 100%);
    color: var(--white);
  }
  .items-table th {
    padding: 9px 10px; text-align: left;
    font-weight: 700; font-size: 11px;
    letter-spacing: 0.04em; white-space: nowrap;
  }
  .items-table th.center { text-align: center; }
  .items-table tbody tr:nth-child(even) { background: var(--row-even); }
  .items-table tbody tr:nth-child(odd)  { background: var(--row-odd); }
  .items-table tbody tr:hover { background: var(--sky); }
  .items-table td { padding: 6px 6px; vertical-align: middle; }

  .items-table td input, .items-table td textarea {
    border: 1.5px solid var(--border); border-radius: 4px;
    padding: 6px 8px; font-family: inherit; font-size: 13px;
    width: 100%; background: transparent;
    transition: border-color 0.12s, background 0.12s, box-shadow 0.12s;
  }
  .items-table td input:focus, .items-table td textarea:focus {
    outline: none; border-color: var(--primary);
    background: var(--white);
    box-shadow: 0 0 0 2px rgba(21,101,192,0.12);
  }
  .items-table td input.error { border-color: var(--accent); background: var(--accent-soft); }
  .items-table td textarea { resize: vertical; min-height: 36px; line-height: 1.5; }

  /* URLæ¬„å°‚ç”¨: æ¨ªã‚¹ã‚¯ãƒ­ãƒ¼ãƒ« + ãƒªãƒ³ã‚¯è¡¨ç¤º */
  .url-cell-wrap { display: flex; flex-direction: column; gap: 3px; }
  .url-cell-wrap input { font-size: 12px; }
  .url-preview {
    font-size: 11px;
    color: var(--primary);
    text-decoration: underline;
    cursor: pointer;
    overflow: hidden;
    text-overflow: ellipsis;
    white-space: nowrap;
    max-width: 180px;
    display: none;
  }
  .url-preview:hover { color: var(--primary-dk); }

  .col-no   { width: 36px; text-align: center; color: var(--ink-light); font-weight: 700; }
  .col-name { min-width: 130px; }
  .col-qty  { width: 68px; }
  .col-unit { width: 110px; }
  .col-sub  { width: 100px; }
  .col-note { min-width: 140px; }
  .col-url  { min-width: 180px; }
  .col-del  { width: 36px; text-align: center; }

  .subtotal-cell {
    text-align: right; font-weight: 700;
    padding-right: 10px; color: var(--ink);
    font-size: 13px; white-space: nowrap;
  }

  .btn-del {
    background: none; border: 1.5px solid var(--border);
    border-radius: 4px; color: var(--ink-light);
    cursor: pointer; width: 28px; height: 28px;
    display: flex; align-items: center; justify-content: center;
    font-size: 16px;
    transition: border-color 0.12s, color 0.12s, background 0.12s;
    margin: auto;
  }
  .btn-del:hover { border-color: var(--accent); color: var(--accent); background: var(--accent-soft); }

  /* ===== ADD ROW / TOTAL ===== */
  .table-footer {
    display: flex; align-items: center;
    justify-content: space-between; flex-wrap: wrap; gap: 12px;
  }
  .btn-add {
    display: inline-flex; align-items: center; gap: 7px;
    padding: 8px 18px; background: var(--primary);
    color: var(--white); border: none; border-radius: 4px;
    font-family: inherit; font-size: 13px; font-weight: 700;
    cursor: pointer; letter-spacing: 0.04em;
    transition: background 0.15s;
    box-shadow: 0 2px 6px rgba(21,101,192,0.18);
  }
  .btn-add:hover { background: var(--primary-dk); }

  .total-display {
    display: flex; align-items: baseline; gap: 10px;
    background: var(--sky); border: 1.5px solid var(--sky2);
    border-radius: 6px; padding: 8px 20px;
  }
  .total-label { font-size: 12px; font-weight: 700; letter-spacing: 0.1em; color: var(--primary); }
  .total-amount { font-size: 26px; font-weight: 700; color: var(--primary-dk); letter-spacing: 0.02em; }
  .total-unit { font-size: 13px; color: var(--ink-light); }

  /* ===== SUBMIT ===== */
  .submit-area {
    display: flex; flex-direction: column;
    align-items: center; gap: 16px;
    padding: 32px 24px; background: var(--white);
    border: 1px solid var(--border); border-radius: 6px;
    box-shadow: var(--shadow);
  }
  .btn-submit {
    padding: 14px 56px;
    background: linear-gradient(135deg, var(--primary) 0%, var(--primary-lt) 100%);
    color: var(--white); border: none; border-radius: 4px;
    font-family: inherit; font-size: 16px; font-weight: 700;
    letter-spacing: 0.12em; cursor: pointer;
    transition: opacity 0.15s, transform 0.1s;
    box-shadow: 0 4px 14px rgba(21,101,192,0.30);
    min-width: 200px;
  }
  .btn-submit:hover { opacity: 0.9; transform: translateY(-1px); }
  .btn-submit:active { transform: translateY(0); }
  .btn-submit:disabled { background: var(--border); color: #999; box-shadow: none; cursor: not-allowed; }
  .submit-note { font-size: 12px; color: var(--ink-light); opacity: 0.7; }

  /* ===== OVERLAY / MODAL ===== */
  .overlay {
    display: none; position: fixed; inset: 0;
    background: rgba(13,37,64,0.55); z-index: 100;
    align-items: center; justify-content: center;
  }
  .overlay.show { display: flex; }
  .modal {
    background: var(--white); border-radius: 8px;
    padding: 40px 48px; text-align: center;
    max-width: 400px; width: 90%;
    box-shadow: 0 8px 40px rgba(13,71,161,0.22);
    animation: popIn 0.25s ease;
  }
  @keyframes popIn {
    from { transform: scale(0.88) translateY(12px); opacity: 0; }
    to   { transform: scale(1) translateY(0); opacity: 1; }
  }
  .modal-icon {
    width: 64px; height: 64px; background: var(--success);
    border-radius: 50%; display: flex; align-items: center;
    justify-content: center; margin: 0 auto 18px;
    font-size: 32px; color: white;
  }
  .modal h2 { font-size: 20px; font-weight: 700; margin-bottom: 8px; }
  .modal p { font-size: 13px; color: var(--ink-light); margin-bottom: 6px; }
  .modal .req-id { font-size: 16px; font-weight: 700; color: var(--primary-dk); letter-spacing: 0.06em; }
  .btn-close-modal {
    margin-top: 24px; padding: 10px 32px;
    background: var(--primary); color: var(--white);
    border: none; border-radius: 4px; font-family: inherit;
    font-size: 14px; font-weight: 700; cursor: pointer;
    transition: background 0.12s;
  }
  .btn-close-modal:hover { background: var(--primary-dk); }

  .spinner {
    display: none; width: 22px; height: 22px;
    border: 3px solid rgba(255,255,255,0.4);
    border-top-color: white; border-radius: 50%;
    animation: spin 0.7s linear infinite; margin: 0 auto;
  }
  @keyframes spin { to { transform: rotate(360deg); } }
  .btn-submit.loading .btn-label { display: none; }
  .btn-submit.loading .spinner { display: block; }

  .error-box {
    display: none; background: var(--accent-soft);
    border: 1.5px solid var(--accent); border-radius: 4px;
    padding: 12px 16px; font-size: 13px; color: var(--accent);
    width: 100%; text-align: left;
  }
  .error-box.show { display: block; }

  @media (max-width: 680px) {
    .form-grid { grid-template-columns: 1fr; }
    .site-header { padding: 0 16px; }
    .container { margin: 16px auto; }
    .section-body, .submit-area { padding: 14px; }
    .items-table { font-size: 12px; }
    .budget-group { flex-direction: column; gap: 8px; }
    .pw-card { padding: 32px 24px; }
  }
</style>
</head>
<body>

<header class="site-header">
  <div class="header-accent"></div>
  <div class="header-content">
    <div class="header-title">æ¶ˆè€—å“ã€€è³¼å…¥ç”³è«‹ãƒ•ã‚©ãƒ¼ãƒ </div>
  </div>
</header>

<!-- ===== ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰èªè¨¼ç”»é¢ ===== -->
<div id="pwScreen">
  <div class="pw-card">
    <div class="pw-icon">ğŸ”‘</div>
    <h2>ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„</h2>
    <p>ã“ã®ãƒ•ã‚©ãƒ¼ãƒ ã¯è·å“¡å°‚ç”¨ã§ã™ã€‚<br>æ‹…å½“è€…ã‹ã‚‰ãŠçŸ¥ã‚‰ã›ã—ãŸãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„ã€‚</p>
    <div class="pw-input-wrap">
      <input type="password" id="pwInput" placeholder="â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢"
        onkeydown="if(event.key==='Enter') checkPassword()">
      <button class="pw-toggle" onclick="togglePw()" title="è¡¨ç¤º/éè¡¨ç¤º">ğŸ‘</button>
    </div>
    <div class="pw-error" id="pwError"></div>
    <button class="btn-pw" onclick="checkPassword()">ãƒ­ã‚°ã‚¤ãƒ³</button>
    <p class="pw-hint">â€» ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ã¯ç®¡ç†è€…ã«ãŠå•ã„åˆã‚ã›ãã ã•ã„</p>
  </div>
</div>

<!-- ===== ç”³è«‹ãƒ•ã‚©ãƒ¼ãƒ æœ¬ä½“ ===== -->
<div id="mainForm">
<div class="container">

  <!-- SECTION 1: ç”³è«‹è€… -->
  <div class="section">
    <div class="section-head"><span class="num">1</span> ç”³è«‹è€…</div>
    <div class="section-body">
      <div class="form-grid">
        <div class="field">
          <label>ç”³è«‹è€…å <span class="required">*</span></label>
          <input type="text" id="applicantName" placeholder="ä¾‹: å±±ç”° å¤ªéƒ">
          <span class="err-msg">ç”³è«‹è€…åã‚’å…¥åŠ›ã—ã¦ãã ã•ã„</span>
        </div>
        <div class="field">
          <label>ç­å <span class="required">*</span></label>
          <select id="department">
            <option value="">â€• é¸æŠã—ã¦ãã ã•ã„ â€•</option>
            <option value="ç®¡ç†ç­">ç®¡ç†ç­</option>
            <option value="æŒ‡å°ç­">æŒ‡å°ç­</option>
            <option value="ãƒ—ãƒ¼ãƒ«ç­">ãƒ—ãƒ¼ãƒ«ç­</option>
            <option value="é‡çƒå ´ç­">é‡çƒå ´ç­</option>
          </select>
          <span class="err-msg">ç­åã‚’é¸æŠã—ã¦ãã ã•ã„</span>
        </div>
      </div>
    </div>
  </div>

  <!-- SECTION 2: ç”¨é€” -->
  <div class="section">
    <div class="section-head"><span class="num">2</span> è³¼å…¥ç›®çš„ãƒ»ç”¨é€”</div>
    <div class="section-body">
      <div class="form-grid full">
        <div class="field">
          <label>ç”¨é€”ãƒ»ç†ç”± <span class="required">*</span></label>
          <textarea id="purpose" placeholder="ä¾‹: äº‹å‹™æ‰€å†…ã§ä½¿ç”¨ã™ã‚‹ã‚³ãƒ”ãƒ¼ç”¨ç´™ãŒåœ¨åº«åˆ‡ã‚Œã«ãªã£ãŸãŸã‚ã€è£œå……è³¼å…¥ã™ã‚‹ã€‚"></textarea>
          <span class="err-msg">ç”¨é€”ãƒ»ç†ç”±ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„</span>
        </div>
      </div>
    </div>
  </div>

  <!-- SECTION 3: å“ç›®ä¸€è¦§ -->
  <div class="section">
    <div class="section-head"><span class="num">3</span> è³¼å…¥å“ç›®ä¸€è¦§</div>
    <div class="section-body">

      <!-- äºˆç®—ç§‘ç›® -->
      <div class="budget-wrap">
        <span class="budget-label-top">äºˆç®—ç§‘ç›® <span class="required">*</span></span>
        <div class="budget-group" id="budgetGroup">
          <label>
            <input type="radio" name="budget" value="æ–½è¨­ç®¡ç†é‹å–¶äº‹æ¥­è²»" onchange="updateBudgetStyle()">
            æ–½è¨­ç®¡ç†é‹å–¶äº‹æ¥­è²»
          </label>
          <label>
            <input type="radio" name="budget" value="ã‚¹ãƒãƒ¼ãƒ„æŒ¯èˆˆäº‹æ¥­è²»" onchange="updateBudgetStyle()">
            ã‚¹ãƒãƒ¼ãƒ„æŒ¯èˆˆäº‹æ¥­è²»
          </label>
        </div>
        <div class="budget-error" id="budgetError">äºˆç®—ç§‘ç›®ã‚’é¸æŠã—ã¦ãã ã•ã„</div>
      </div>

      <div style="overflow-x:auto;">
        <table class="items-table" id="itemsTable">
          <thead>
            <tr>
              <th class="col-no center">No.</th>
              <th class="col-name">å“ç›®å <span style="opacity:0.75">*</span></th>
              <th class="col-qty center">æ•°é‡ <span style="opacity:0.75">*</span></th>
              <th class="col-unit">ç¨è¾¼å˜ä¾¡ï¼ˆå††ï¼‰ <span style="opacity:0.75">*</span></th>
              <th class="col-sub">å°è¨ˆï¼ˆå††ï¼‰</th>
              <th class="col-note">å‚™è€ƒï¼ˆå“åãƒ»å‹ç•ªç­‰ï¼‰</th>
              <th class="col-url">å‚è€ƒURL</th>
              <th class="col-del"></th>
            </tr>
          </thead>
          <tbody id="itemsBody"></tbody>
        </table>
      </div>

      <div class="table-footer">
        <button class="btn-add" onclick="addRow()">ï¼‹ å“ç›®ã‚’è¿½åŠ </button>
        <div class="total-display">
          <span class="total-label">åˆè¨ˆé‡‘é¡</span>
          <span class="total-amount" id="totalAmount">0</span>
          <span class="total-unit">å††</span>
        </div>
      </div>
    </div>
  </div>

  <!-- SUBMIT -->
  <div class="submit-area">
    <div class="error-box" id="globalError"></div>
    <button class="btn-submit" id="submitBtn" onclick="submitForm()">
      <span class="btn-label">ç”³è«‹ã‚’é€ä¿¡ã™ã‚‹</span>
      <div class="spinner"></div>
    </button>
    <p class="submit-note">é€ä¿¡å¾Œã€ã‚¹ãƒ—ãƒ¬ãƒƒãƒ‰ã‚·ãƒ¼ãƒˆã«è‡ªå‹•ã§è¨˜éŒ²ã•ã‚Œã¾ã™</p>
  </div>

</div>
</div><!-- /mainForm -->

<!-- SUCCESS MODAL -->
<div class="overlay" id="successOverlay">
  <div class="modal">
    <div class="modal-icon">âœ“</div>
    <h2>ç”³è«‹ãŒå®Œäº†ã—ã¾ã—ãŸ</h2>
    <p style="margin-top:8px;">ç”³è«‹ç•ªå·</p>
    <div class="req-id" id="modalReqId">â€”</div>
    <p style="margin-top:16px;">ã‚¹ãƒ—ãƒ¬ãƒƒãƒ‰ã‚·ãƒ¼ãƒˆã¸ã®è¨˜éŒ²ãŒå®Œäº†ã—ã¾ã—ãŸã€‚</p>
    <button class="btn-close-modal" onclick="closeModal()">æ–°ã—ã„ç”³è«‹ã‚’ä½œæˆ</button>
  </div>
</div>

<script>
// ============================================================
// â˜… è¨­å®šã‚¨ãƒªã‚¢ â€• ã“ã“ã ã‘æ›¸ãæ›ãˆã¦ãã ã•ã„
// ============================================================
const PASSWORD   = '1221';              // â† ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ã‚’å¤‰æ›´
const GAS_URL    = 'https://script.google.com/macros/s/AKfycbxa2mNy9hU-dUNr-yU5lJDTP_fATNsujEeBAbiDJE18UHnjgjnIHfWTUW02DBz3BdoP/exec'; // â† GAS Webã‚¢ãƒ—ãƒªURL
// ============================================================

let rowCount = 0;

/* ---------- ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰èªè¨¼ ---------- */
function checkPassword() {
  const val = document.getElementById('pwInput').value;
  if (val === PASSWORD) {
    document.getElementById('pwScreen').style.display = 'none';
    document.getElementById('mainForm').style.display = 'block';
    addRow(); addRow(); addRow();
  } else {
    const inp = document.getElementById('pwInput');
    inp.classList.add('error');
    document.getElementById('pwError').textContent = 'ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ãŒæ­£ã—ãã‚ã‚Šã¾ã›ã‚“ã€‚';
    inp.value = '';
    inp.focus();
    setTimeout(() => inp.classList.remove('error'), 1500);
  }
}

function togglePw() {
  const inp = document.getElementById('pwInput');
  inp.type = inp.type === 'password' ? 'text' : 'password';
}

/* ---------- äºˆç®—ç§‘ç›® ---------- */
function updateBudgetStyle() {
  document.querySelectorAll('.budget-group label').forEach(lbl => {
    lbl.classList.toggle('selected', lbl.querySelector('input').checked);
  });
  document.getElementById('budgetError').classList.remove('show');
}

/* ---------- å“ç›®è¡Œã®è¿½åŠ  ---------- */
function addRow() {
  rowCount++;
  const n = rowCount;
  const tbody = document.getElementById('itemsBody');
  const tr = document.createElement('tr');
  tr.id = 'row-' + n;
  tr.innerHTML = `
    <td class="col-no">${n}</td>
    <td class="col-name">
      <input type="text" id="name_${n}" placeholder="ä¾‹: ã‚³ãƒ”ãƒ¼ç”¨ç´™ A4">
    </td>
    <td class="col-qty">
      <input type="text" id="qty_${n}" placeholder="1" inputmode="numeric"
        oninput="validateNum(this); calcRow(${n})">
    </td>
    <td class="col-unit">
      <input type="text" id="unit_${n}" placeholder="1000" inputmode="numeric"
        oninput="validateNum(this); calcRow(${n})">
    </td>
    <td class="col-sub">
      <div class="subtotal-cell" id="sub_${n}">â€”</div>
    </td>
    <td class="col-note">
      <textarea id="note_${n}" placeholder="ä¾‹: â—‹â—‹ãƒ¡ãƒ¼ã‚«ãƒ¼ å“ç•ªXX-123" rows="2"></textarea>
    </td>
    <td class="col-url">
      <div class="url-cell-wrap">
        <input type="url" id="url_${n}" placeholder="https://"
          oninput="updateUrlPreview(${n})" onpaste="setTimeout(()=>updateUrlPreview(${n}),50)">
        <span class="url-preview" id="urlprev_${n}" onclick="openUrl(${n})"></span>
      </div>
    </td>
    <td class="col-del">
      <button class="btn-del" onclick="delRow(${n})" title="å‰Šé™¤">Ã—</button>
    </td>`;
  tbody.appendChild(tr);
  document.getElementById('name_' + n).focus();
}

/* ---------- URL ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼ ---------- */
function updateUrlPreview(n) {
  const val  = document.getElementById('url_' + n)?.value.trim();
  const prev = document.getElementById('urlprev_' + n);
  if (prev) {
    if (val && (val.startsWith('http://') || val.startsWith('https://'))) {
      prev.textContent = val.length > 40 ? val.slice(0, 40) + 'â€¦' : val;
      prev.style.display = 'block';
    } else {
      prev.style.display = 'none';
    }
  }
}

function openUrl(n) {
  const val = document.getElementById('url_' + n)?.value.trim();
  if (val) window.open(val, '_blank', 'noopener');
}

/* ---------- è¡Œå‰Šé™¤ ---------- */
function delRow(n) {
  if (document.querySelectorAll('#itemsBody tr').length <= 1) {
    alert('å“ç›®ã¯æœ€ä½1ä»¶å¿…è¦ã§ã™ã€‚'); return;
  }
  document.getElementById('row-' + n).remove();
  calcTotal();
  document.querySelectorAll('#itemsBody tr').forEach((tr, i) => {
    tr.querySelector('td.col-no').textContent = i + 1;
  });
}

/* ---------- æ•°å€¤ãƒãƒªãƒ‡ãƒ¼ã‚·ãƒ§ãƒ³ ---------- */
function validateNum(input) {
  const cleaned = input.value
    .replace(/[ï¼-ï¼™]/g, s => String.fromCharCode(s.charCodeAt(0) - 0xFEE0))
    .replace(/[^0-9]/g, '');
  input.value = cleaned;
  input.classList.toggle('error', !cleaned || Number(cleaned) < 0);
}

/* ---------- å°è¨ˆãƒ»åˆè¨ˆè¨ˆç®— ---------- */
function calcRow(n) {
  const qty  = parseInt(document.getElementById('qty_'  + n)?.value) || 0;
  const unit = parseInt(document.getElementById('unit_' + n)?.value) || 0;
  const sub  = qty * unit;
  const cell = document.getElementById('sub_' + n);
  if (cell) cell.textContent = sub > 0 ? sub.toLocaleString() + ' å††' : 'â€”';
  calcTotal();
}

function calcTotal() {
  let total = 0;
  document.querySelectorAll('#itemsBody tr').forEach(tr => {
    const id   = tr.id.replace('row-', '');
    const qty  = parseInt(document.getElementById('qty_'  + id)?.value) || 0;
    const unit = parseInt(document.getElementById('unit_' + id)?.value) || 0;
    total += qty * unit;
  });
  document.getElementById('totalAmount').textContent = total.toLocaleString();
}

/* ---------- ãƒ•ã‚©ãƒ¼ãƒ ãƒãƒªãƒ‡ãƒ¼ã‚·ãƒ§ãƒ³ ---------- */
function validateForm() {
  let valid = true;

  ['applicantName', 'department', 'purpose'].forEach(id => {
    const el = document.getElementById(id);
    const ok = el.value.trim() !== '';
    el.classList.toggle('error', !ok);
    if (!ok) valid = false;
  });

  const budgetVal = document.querySelector('input[name="budget"]:checked')?.value;
  if (!budgetVal) {
    document.getElementById('budgetError').classList.add('show');
    valid = false;
  } else {
    document.getElementById('budgetError').classList.remove('show');
  }

  let hasValidItem = false;
  document.querySelectorAll('#itemsBody tr').forEach(tr => {
    const id     = tr.id.replace('row-', '');
    const nameEl = document.getElementById('name_' + id);
    const qtyEl  = document.getElementById('qty_'  + id);
    const unitEl = document.getElementById('unit_' + id);
    const name = nameEl?.value.trim();
    const qty  = qtyEl?.value.trim();
    const unit = unitEl?.value.trim();
    if (!name && !qty && !unit) return;

    let rowOk = true;
    if (!name) { nameEl.classList.add('error'); rowOk = false; valid = false; }
    else nameEl.classList.remove('error');
    if (!qty || !/^\d+$/.test(qty) || Number(qty) <= 0) {
      qtyEl.classList.add('error'); rowOk = false; valid = false;
    } else qtyEl.classList.remove('error');
    if (!unit || !/^\d+$/.test(unit) || Number(unit) <= 0) {
      unitEl.classList.add('error'); rowOk = false; valid = false;
    } else unitEl.classList.remove('error');
    if (rowOk) hasValidItem = true;
  });

  if (!hasValidItem) {
    showError('å“ç›®ã‚’æœ€ä½1ä»¶å…¥åŠ›ã—ã¦ãã ã•ã„ã€‚æ•°é‡ãƒ»ç¨è¾¼å˜ä¾¡ã¯åŠè§’æ•°å­—ã§å…¥åŠ›ã—ã¦ãã ã•ã„ã€‚');
    valid = false;
  }
  return valid;
}

/* ---------- é€ä¿¡ ---------- */
function showError(msg) {
  const box = document.getElementById('globalError');
  box.textContent = msg; box.classList.add('show');
}
function clearError() { document.getElementById('globalError').classList.remove('show'); }

function submitForm() {
  clearError();
  if (!validateForm()) {
    document.querySelector('.error-box.show, input.error, textarea.error, select.error')
      ?.scrollIntoView({ behavior: 'smooth', block: 'center' });
    return;
  }

  const items = [];
  document.querySelectorAll('#itemsBody tr').forEach(tr => {
    const id   = tr.id.replace('row-', '');
    const name = document.getElementById('name_' + id)?.value.trim();
    const qty  = document.getElementById('qty_'  + id)?.value.trim();
    const unit = document.getElementById('unit_' + id)?.value.trim();
    const note = document.getElementById('note_' + id)?.value.trim() || '';
    const url  = document.getElementById('url_'  + id)?.value.trim() || '';
    if (name && qty && unit) {
      items.push({ name, quantity: qty, unitPrice: unit, note, url });
    }
  });

  const totalText = document.getElementById('totalAmount').textContent.replace(/,/g, '');
  const data = {
    applicantName: document.getElementById('applicantName').value.trim(),
    department:    document.getElementById('department').value,
    budget:        document.querySelector('input[name="budget"]:checked').value,
    purpose:       document.getElementById('purpose').value.trim(),
    items,
    totalAmount:   Number(totalText)
  };

  const btn = document.getElementById('submitBtn');
  btn.disabled = true; btn.classList.add('loading');

  fetch(GAS_URL, {
    method: 'POST', mode: 'no-cors',
    headers: { 'Content-Type': 'application/json' },
    body: JSON.stringify(data)
  })
  .then(() => {
    const reqId = 'REQ-' + new Date().toISOString().slice(0,10).replace(/-/g,'')
                + '-' + String(Math.floor(Math.random()*9000)+1000);
    showSuccess(reqId);
  })
  .catch(err => {
    btn.disabled = false; btn.classList.remove('loading');
    showError('é€ä¿¡ä¸­ã«ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ: ' + err.message);
  });
}

function showSuccess(reqId) {
  document.getElementById('modalReqId').textContent = reqId;
  document.getElementById('successOverlay').classList.add('show');
  document.getElementById('submitBtn').classList.remove('loading');
}

function closeModal() {
  document.getElementById('successOverlay').classList.remove('show');
  document.getElementById('applicantName').value = '';
  document.getElementById('department').value = '';
  document.getElementById('purpose').value = '';
  document.querySelectorAll('input[name="budget"]').forEach(r => r.checked = false);
  document.querySelectorAll('.budget-group label').forEach(l => l.classList.remove('selected'));
  document.getElementById('itemsBody').innerHTML = '';
  rowCount = 0;
  addRow(); addRow(); addRow();
  document.getElementById('totalAmount').textContent = '0';
  document.getElementById('submitBtn').disabled = false;
}
</script>
</body>
</html>
